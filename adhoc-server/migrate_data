export ADHOC_USER=${ADHOC_USER:-srvadhoc}
export ADHOC_USER_HOME=$(eval echo ~${ADHOC_USER})
export ADHOC_RUNTIME_HOME=${ADHOC_USER_HOME}/adhoc-server
export INSTALL_HOME=$ADHOC_RUNTIME_HOME

cd $ADHOC_RUNTIME_HOME || exit 1

/etc/init.d/adhoc-server stop
export CHALMERS_DEPLOY_LEVEL="install"
export ADHOC_GENERIC_PASSWORD='hgUUw/fsy%6gh'
export PYTHONPATH=$PYTHONPATH:$ADHOC_RUNTIME_HOME/lib/python2.6
. $ADHOC_RUNTIME_HOME/etc/bashrc.public
. $ADHOC_USER_HOME/etc/bashrc.private
/etc/init.d/adhoc-server start

sleep 1

python <<EOF
import rpcc_client
import os
url=os.environ["ADHOC_SERVER_URL"]
pw = os.environ["ADHOC_GENERIC_PASSWORD"]
q = rpcc_client.RPCC(url, 0)
q.session_auth_login('bernerus',pw)
q.dhcp_xfer()
q.session_deauth()
q.session_stop()
EOF

unset CHALMERS_DEPLOY_LEVEL
unset ADHOC_GENERIC_PASSWORD
/etc/init.d/adhoc-server stop
/etc/init.d/adhoc-server start

echo "Migration is done. If in a hurry to do administration of DHCP, contact the PDB integrations team"
echo "to get a full update of accounts and privileges done quickly."
echo "In any case, a full update will be made overnight"